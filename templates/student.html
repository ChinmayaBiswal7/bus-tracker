<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Tracker</title>
    <!-- Leaflet CSS -->
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>

    <!-- PWA Setup -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0f172a">

    <!-- PWA Install & Cache Logic -->
    <script>
        // PWA Install Logic
        let deferredPrompt;
        window.addEventListener('load', () => {
            const installBtn = document.getElementById('install-btn');

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                if (installBtn) installBtn.classList.remove('hidden');
                console.log("PWA Install Prompt ready");
            });

            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        console.log(`User response to the install prompt: ${outcome}`);
                        deferredPrompt = null;
                        installBtn.classList.add('hidden');
                    }
                });
            }

            window.addEventListener('appinstalled', () => {
                if (installBtn) installBtn.classList.add('hidden');
                deferredPrompt = null;
                console.log('PWA was installed');
            });
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(reg => console.log('SW Registered!', reg.scope))
                    .catch(err => console.log('SW Failed:', err));
            });
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        #map {
            height: 100vh;
            width: 100%;
            z-index: 1;
            /* Dark Mode Map Filter */
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }

        /* Prevent map controls from being inverted */
        .leaflet-control-container {
            filter: invert(100%) hue-rotate(180deg) brightness(105%) contrast(110%);
        }

        .pulse-ring {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 9999px;
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            /* Blue-500 */
            animation: pulse-blue 2s infinite;
            z-index: -1;
        }

        @keyframes pulse-blue {
            0% {
                transform: translate(-50%, -50%) scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                transform: translate(-50%, -50%) scale(2);
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }

            100% {
                transform: translate(-50%, -50%) scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        /* Ensure User Marker is visible */
        .custom-user-icon {
            z-index: 1000 !important;
        }

        /* GPS Status Indicator (Processed by Tailwind Classes now) */
    </style>
</head>

<body class="h-screen w-screen overflow-hidden relative bg-slate-900" style="display: none;" id="main-body">
    <!-- Global Debug Handler -->
    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            if (msg.includes("extension") || msg.includes("ResizeObserver")) return false;
            alert("System Error: " + msg + "\nLine: " + lineNo);
            return false;
        };
    </script>
    <!-- Auth Guard -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const guardConfig = {
            apiKey: "AIzaSyAW7XS_Q_Kdh2eiYEaKBEHvZDpOk7-ynDg",
            authDomain: "bustracker-c0af6.firebaseapp.com",
            projectId: "bustracker-c0af6",
            storageBucket: "bustracker-c0af6.firebasestorage.app",
            messagingSenderId: "103145940746",
            appId: "1:103145940746:web:80a8444bff23e75b94fcf3",
            measurementId: "G-PKF72NB657"
        };

        const guardApp = initializeApp(guardConfig);
        window.firebaseApp = guardApp;
        const auth = getAuth(guardApp);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                console.log("Auth Guard: User is logged in", user.email);
                document.getElementById('main-body').style.display = 'block';
                // Update username
                const nameEl = document.getElementById('user-display-name');
                if (nameEl) nameEl.textContent = user.displayName || user.email.split('@')[0];

                // Fix Leaflet sizing issue (Robust Retry)
                let attempts = 0;
                const resizeInterval = setInterval(() => {
                    attempts++;
                    if (window.map) {
                        window.map.invalidateSize();
                        console.log("Map resized successfully");
                        clearInterval(resizeInterval);
                    }
                    if (attempts > 30) clearInterval(resizeInterval); // Stop after 3s
                }, 100);
            } else {
                // No user is signed in
                console.log("Auth Guard: No user, redirecting...");
                window.location.href = '/login?role=student';
            }
        });

        window.logout = function () {
            auth.signOut().then(() => {
                window.location.href = '/';
            }).catch((error) => {
                console.error("Logout failed:", error);
            });
        }
    </script>

    <!-- Top Navigation Bar (Task Bar) -->
    <header
        class="fixed top-0 left-0 w-full h-16 z-[2000] bg-slate-900/95 backdrop-blur-xl border-b border-slate-700 flex items-center justify-between px-4 shadow-lg text-white">

        <!-- Left: Menu & Brand -->
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()"
                class="p-2 -ml-2 text-slate-300 hover:text-white hover:bg-white/10 rounded-full transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                    </path>
                </svg>
            </button>
            <h1 class="text-lg font-bold text-white tracking-tight block">Campus Ride</h1>
        </div>

        <!-- Right: Status Indicators -->
        <div class="flex items-center gap-3">
            <!-- Status Badges -->
            <div class="flex items-center gap-2">
                <div class="flex items-center gap-1.5 bg-slate-800/80 px-2.5 py-1 rounded-full border border-slate-700">
                    <span class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse" id="gps-dot"></span>
                    <span class="text-[10px] font-bold text-slate-200" id="gps-text">GPS: Locating</span>
                </div>
                <div class="flex items-center gap-1.5 bg-slate-800/80 px-2.5 py-1 rounded-full border border-slate-700">
                    <span class="w-1.5 h-1.5 rounded-full bg-red-500" id="server-dot"></span>
                    <span class="text-[10px] font-bold text-slate-200" id="server-text">Server: Offline</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area (Map) -->
    <!-- Adjusted height to account for 4rem (h-16) header -->
    <div id="map" class="absolute top-16 left-0 right-0 bottom-0 z-0 h-[calc(100%-4rem)]"></div>

    <!-- Trip Info Card (Compact Pill) -->
    <div id="trip-info-card"
        class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-full shadow-[0_0_20px_rgba(37,99,235,0.5)] z-[900] hidden flex items-center gap-4 transition-all duration-300 transform scale-100 border border-blue-400/50 backdrop-blur-md">
        <div class="flex flex-col items-start leading-tight">
            <span class="text-[10px] font-bold opacity-90 uppercase tracking-widest">Arrival</span>
            <span id="trip-eta" class="text-lg font-bold font-mono">-- min</span>
        </div>
        <div class="h-8 w-px bg-white/20"></div>
        <div class="flex flex-col items-start leading-tight">
            <span class="text-[10px] font-bold opacity-90 uppercase tracking-widest">Dist</span>
            <span id="trip-dist" class="text-sm font-mono opacity-90">-- km</span>
        </div>
        <button onclick="stopTrackingRoute()"
            class="bg-white/10 hover:bg-white/20 rounded-full p-1.5 ml-1 transition-colors">
            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <!-- Sidebar (Off-Canvas) -->
    <div id="sidebar"
        class="fixed top-0 left-0 h-[100dvh] w-[85vw] sm:w-80 z-[2000] transform -translate-x-full transition-transform duration-300 ease-in-out
                bg-slate-900/95 backdrop-blur-xl border-r border-slate-700 p-5 text-white flex flex-col shadow-2xl pb-24 overflow-y-auto">

        <!-- Header & Nav -->
        <!-- Header & Nav -->
        <div class="flex items-center justify-between mb-4 shrink-0">
            <div class="flex items-center gap-2">
                <h1 class="font-bold text-xl tracking-tight">Campus Ride</h1>
            </div>
            <button onclick="toggleSidebar()" class="p-2 hover:bg-white/10 rounded-full transition-colors">
                <svg class="w-5 h-5 text-slate-400 hover:text-white" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>

        <p class="text-xs text-slate-400 mb-4">Welcome, <span id="user-display-name"
                class="text-blue-400 font-bold">Student</span></p>

        <!-- Search -->
        <div class="relative mb-6 shrink-0">
            <input type="text" id="trackInput" placeholder="Find bus (e.g. 42)"
                class="w-full bg-slate-700/50 border border-slate-600 rounded-xl py-3 pl-4 pr-12 text-sm focus:outline-none focus:border-blue-500 transition-colors uppercase placeholder-slate-500 h-11">
            <button onclick="setFilter()"
                class="absolute right-1.5 top-1.5 bottom-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors">
                GO
            </button>
        </div>



        <!-- Recommendations -->
        {% if recommendations %}
        <div class="mb-4 shrink-0">
            <p class="text-[10px] uppercase text-slate-500 font-bold mb-2 tracking-wider">Recommended for you</p>
            <div class="flex flex-wrap gap-2">
                {% for bus in recommendations %}
                <button onclick="quickSearch('{{ bus }}')"
                    class="px-3 py-1 bg-blue-900/40 border border-blue-700/50 hover:border-blue-500 rounded-lg text-xs text-blue-200 transition-all font-mono">
                    {{ bus }}
                </button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <p id="tracking-status" class="text-xs text-blue-300 mb-2 hidden flex items-center gap-2 shrink-0">
            <span>Tracking:</span>
            <span id="fw-bold" class="font-bold text-white">All</span>
        </p>



        <!-- Bus List -->
        <div class="space-y-2 overflow-y-auto pr-1 flex-1 min-h-0 custom-scrollbar">
            <div id="bus-list" class="space-y-2">
                <p class="text-xs text-slate-500 text-center py-4 italic">Scanning for active buses...</p>
            </div>
        </div>

        <!-- Sidebar Menu Items -->
        <div class="space-y-2 mt-auto pt-4 border-t border-slate-700/50">
            <!-- PWA Install Button (Hidden by default) -->
            <button id="install-btn"
                class="w-full flex items-center gap-3 p-3 bg-blue-600/20 hover:bg-blue-600/30 rounded-xl border border-blue-500/50 transition-all hidden group mb-2">
                <div class="p-2 bg-blue-500 rounded-lg text-white group-hover:scale-110 transition-transform">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                </div>
                <div class="text-left">
                    <p class="font-bold text-blue-100 text-sm">Install App</p>
                    <p class="text-[10px] text-blue-300">Add to Home Screen</p>
                </div>
            </button>
            <button onclick="openAnnouncements()"
                class="w-full flex items-center justify-between p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-xl border border-slate-700 hover:border-blue-500/50 transition-all group">
                <div class="flex items-center gap-3">
                    <div
                        class="p-2 bg-amber-500/20 rounded-lg text-amber-500 group-hover:text-amber-400 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z">
                            </path>
                        </svg>
                    </div>
                    <span class="font-bold text-slate-200 text-sm">Announcements</span>
                </div>
                <!-- Unread Badge -->
                <span id="badge-count"
                    class="hidden min-w-[20px] h-5 px-1.5 flex items-center justify-center bg-red-500 text-white text-[10px] font-bold rounded-full shadow-lg shadow-red-500/20 ring-2 ring-slate-900 transform scale-100 transition-all">0</span>
            </button>
            <button id="btn-open-sched"
                class="w-full flex items-center justify-between p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-xl border border-slate-700 hover:border-blue-500/50 transition-all group mt-2">
                <div class="flex items-center gap-3">
                    <div
                        class="p-2 bg-purple-500/20 rounded-lg text-purple-500 group-hover:text-purple-400 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <span class="font-bold text-slate-200 text-sm">Bus Schedule</span>
                </div>
            </button>
            <button onclick="openDrivers()"
                class="w-full flex items-center justify-between p-3 bg-slate-800/50 hover:bg-slate-700/50 rounded-xl border border-slate-700 hover:border-blue-500/50 transition-all group mt-2">
                <div class="flex items-center gap-3">
                    <div
                        class="p-2 bg-emerald-500/20 rounded-lg text-emerald-500 group-hover:text-emerald-400 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z">
                            </path>
                        </svg>
                    </div>
                    <span class="font-bold text-slate-200 text-sm">Driver Directory</span>
                </div>
            </button>
            <button onclick="logout()"
                class="w-full flex items-center justify-between p-3 bg-red-900/20 hover:bg-red-900/40 rounded-xl border border-red-900/50 hover:border-red-500 transition-all group mt-2">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-red-500/20 rounded-lg text-red-500 group-hover:text-red-400 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                            </path>
                        </svg>
                    </div>
                    <span class="font-bold text-red-100 text-sm">Logout</span>
                </div>
            </button>
        </div>
    </div>

    <!-- Announcements Overlay -->
    <div id="announcement-overlay"
        class="fixed inset-0 z-[3000] bg-slate-900/95 backdrop-blur-xl hidden flex flex-col transition-all duration-300 transform scale-100 opacity-100">
        <!-- Header -->
        <!-- Header -->
        <div class="p-4 border-b border-slate-800 flex items-center gap-2 bg-slate-900 shadow-xl shrink-0">
            <button onclick="closeAnnouncements()"
                class="p-2 -ml-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors"
                title="Back to Map">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>

            <button onclick="requestNotificationPermission()" id="btn-notify"
                class="p-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors mr-auto relative group"
                title="Enable Notifications">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                    </path>
                </svg>
                <span id="notify-badge"
                    class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
            </button>
            <h2 class="text-lg font-bold text-white tracking-tight ml-auto">Announcements</h2>
        </div>

    </div>
    </div>

    <!-- Drivers Directory Overlay -->
    <div id="drivers-overlay"
        class="fixed inset-0 z-[3000] bg-slate-900/95 backdrop-blur-xl hidden flex flex-col transition-all duration-300 transform scale-100 opacity-100">
        <!-- Header -->
        <div class="p-4 border-b border-slate-800 flex items-center gap-2 bg-slate-900 shadow-xl shrink-0">
            <button onclick="closeDrivers()"
                class="p-2 -ml-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors"
                title="Back to Map">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <h2 class="text-lg font-bold text-white tracking-tight ml-auto">Drivers</h2>
        </div>

        <!-- Driver List -->
        <div id="driver-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
            <!-- Items injected by JS -->
            <p class="text-slate-500 text-center italic mt-10">Loading drivers...</p>
        </div>
    </div>

    <!-- Driver Profile Card Modal -->
    <div id="profile-modal"
        class="fixed inset-0 z-[4000] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div
            class="bg-slate-800 border border-slate-700 w-full max-w-sm rounded-3xl p-6 shadow-2xl relative transform transition-all scale-100">
            <button onclick="closeProfile()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>

            <div class="flex flex-col items-center">
                <div
                    class="w-20 h-20 rounded-full bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-3xl mb-4 shadow-lg">
                    üëÆ‚Äç‚ôÇÔ∏è
                </div>
                <h3 id="profile-name" class="text-xl font-bold text-white mb-1">Driver Name</h3>
                <p class="text-emerald-400 text-xs font-bold uppercase tracking-widest mb-6">Offical Driver</p>

                <div class="w-full bg-slate-900/50 rounded-xl p-4 mb-6 border border-slate-700/50">
                    <p class="text-slate-400 text-xs uppercase mb-1">Mobile Number</p>
                    <p id="profile-mobile" class="text-white font-mono text-lg tracking-wider">--</p>
                </div>

                <a id="profile-call-btn" href="#"
                    class="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-emerald-900/20">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                        </path>
                    </svg>
                    Call Driver
                </a>
            </div>
        </div>

        <!-- Bus Schedules Overlay -->
        <div id="schedule-overlay"
            class="fixed inset-0 z-[3000] bg-slate-900/95 backdrop-blur-xl hidden flex flex-col transition-all duration-300">
            <!-- Header -->
            <div class="p-4 border-b border-slate-800 flex items-center gap-2 bg-slate-900 shadow-xl shrink-0">
                <button onclick="closeSchedule()"
                    class="p-2 -ml-2 hover:bg-slate-800 rounded-full text-slate-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 class="text-lg font-bold text-white tracking-tight ml-auto">Bus Schedule</h2>
            </div>

            <!-- Schedule List -->
            <div id="schedule-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                <p class="text-slate-500 text-center italic mt-10">Loading schedules...</p>
            </div>
        </div>

        <!-- Trip Info Card (GPS Tracking) -->
        <!-- ... (No changes here) ... -->

        <!-- Leaflet JS -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <!-- Leaflet Routing Machine -->
        <link rel="stylesheet"
            href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
        <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
        <style>
            /* Hide the default instruction box of routing machine */
            .leaflet-routing-container {
                display: none !important;
            }
        </style>

        <!-- Firebase SDK & Logic -->
        <script type="module">
            import { getFirestore, collection, query, orderBy, limit, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
            import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

            // Use the app instance from the Auth Guard
            const app = window.firebaseApp;
            const db = getFirestore(app);
            const messaging = getMessaging(app);
            console.log("Student Module Loaded ‚úÖ");

            // --- FCM Logic (Push Notifications) ---
            const VAPID_KEY = "BJoiF9u6UpFvBbNQcjByY3IfcxS9yivCpdcMS5b1jpg4rFoTnM35kZzmgEuVCWgJiBrcofsPLrjh4CoO5i1DZBE";

            async function initFCM() {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        // Visual Debug: Success
                        const debugEl = document.getElementById('debug-status');
                        if (debugEl) debugEl.innerHTML = "üîî Perm: GRANTED";

                        // Wait for Service Worker (merged sw.js)
                        let registration;
                        if ('serviceWorker' in navigator) {
                            try {
                                registration = await navigator.serviceWorker.ready;
                            } catch (e) {
                                console.log("SW Ready Timeout/Error", e);
                            }
                        }

                        const token = await getToken(messaging, {
                            vapidKey: VAPID_KEY,
                            serviceWorkerRegistration: registration
                        });

                        if (token) {
                            console.log("üî• FCM Token:", token);
                            if (debugEl) debugEl.innerHTML = "üî• Token: OK";

                            // Send token to server to subscribe to 'news' topic
                            fetch('/subscribe', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ token: token }),
                            });
                        } else {
                            console.log("No registration token available.");
                            if (debugEl) debugEl.innerHTML = "‚ö†Ô∏è Token: MISSING";
                        }
                    } else {
                        alert("Notifications Denied! Please reset permissions.");
                        const debugEl = document.getElementById('debug-status');
                        if (debugEl) debugEl.innerHTML = "‚ùå Perm: DENIED";
                    }
                } catch (err) {
                    console.log('An error occurred while retrieving token. ', err);
                }
            }

            // Handle foreground messages
            onMessage(messaging, (payload) => {
                console.log('Message received. ', payload);
                sendNotification(payload.notification.title, payload.notification.body);
            });

            // Initialize FCM
            initFCM();

            // --- Notification Logic (Local) ---
            const notifyBtn = document.getElementById('btn-notify');
            const notifyBadge = document.getElementById('notify-badge');

            // Check initial state
            if (Notification.permission === 'granted') {
                notifyBadge.classList.add('hidden');
                notifyBtn.classList.add('text-green-400');
            }

            window.requestNotificationPermission = function () {
                if (Notification.permission === 'granted') {
                    alert("Notifications are already enabled! üîî");
                    return;
                }

                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notifyBadge.classList.add('hidden');
                        notifyBtn.classList.replace('text-slate-400', 'text-green-400');
                        new Notification("Notifications Enabled", {
                            body: "You will now receive alerts for new announcements!",
                            icon: "https://cdn-icons-png.flaticon.com/512/3233/3233914.png"
                        });
                    }
                });
            };

            function sendNotification(title, body) {
                if (Notification.permission === 'granted') {
                    new Notification(title, {
                        body: body,
                        icon: "https://cdn-icons-png.flaticon.com/512/3233/3233914.png"
                    });
                }
            }



            // --- Refactored Announcement Logic (Hierarchical) ---
            // ... (badgeEl, overlayEl, listEl definitions same) ...

            const badgeEl = document.getElementById('badge-count');
            const overlayEl = document.getElementById('announcement-overlay');
            const listEl = document.getElementById('full-announcement-list');

            // 1. Listen for Active Buses (Categories)
            // Optimize: Limit to last 50 messages to fix slow loading
            const qBuses = query(collection(db, "announcements"), orderBy("last_updated", "desc"), limit(50));
            let activeBuses = [];
            let unsubscribeMessages = {}; // Store unsubscribe functions for message listeners

            onSnapshot(qBuses, (snapshot) => {
                activeBuses = [];

                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" || change.type === "modified") {
                        const data = change.doc.data();
                        // Only notify if it's a recent update (prevent spam on reload)
                        const now = new Date();
                        const msgTime = data.last_updated ? data.last_updated.toDate() : new Date(); // Fallback to now if missing

                        // Aggressive Notification: Send popup even if app is open
                        // Relaxed check: 60 seconds to account for network/clock skew
                        if ((now - msgTime) < 60000) {
                            console.log("Triggering Notification for:", data.bus_no);
                            sendNotification(`üì¢ Bus ${data.bus_no}`, data.latest_message || "New announcement");
                        }
                    }
                });

                snapshot.forEach(doc => {
                    const data = doc.data();
                    activeBuses.push({ id: doc.id, ...data });
                });
                updateBadge();

                // FIX: Refresh list if currently viewing
                if (!overlayEl.classList.contains('hidden')) {
                    renderBusList();
                }
            });

            function updateBadge() {
                // ... (Same logic) ...
                if (!badgeEl) return;
                const lastReadStr = localStorage.getItem('lastReadTime');
                let unread = 0;

                if (!activeBuses.length) {
                    badgeEl.classList.add('hidden');
                    return;
                }

                if (!lastReadStr) {
                    unread = activeBuses.length;
                } else {
                    const lastRead = new Date(lastReadStr);
                    unread = activeBuses.filter(bus => {
                        if (!bus.last_updated) return false;
                        return bus.last_updated.toDate() > lastRead;
                    }).length;
                }

                if (unread > 0) {
                    badgeEl.textContent = unread > 9 ? '9+' : unread;
                    badgeEl.classList.remove('hidden');
                } else {
                    badgeEl.classList.add('hidden');
                }
            }

            window.openAnnouncements = function () {
                // ... (Same) ...
                overlayEl.classList.remove('hidden');
                renderBusList();
                localStorage.setItem('lastReadTime', new Date().toISOString());
                updateBadge();
                if (window.innerWidth < 768) toggleSidebar();
            }

            window.closeAnnouncements = function () {
                overlayEl.classList.add('hidden');
            }

            function renderBusList() {
                const currentIds = new Set(activeBuses.map(b => b.id));

                // 1. Remove orphans (Buses that are no longer active)
                Array.from(listEl.children).forEach(child => {
                    // Ensure we only touch bus containers
                    if (!child.id.startsWith('bus-container-')) return;

                    const id = child.id.replace('bus-container-', '');
                    if (!currentIds.has(id)) {
                        if (unsubscribeMessages[id]) {
                            unsubscribeMessages[id]();
                            delete unsubscribeMessages[id];
                        }
                        child.remove();
                    }
                });

                // 2. Clear empty message if we have buses
                if (activeBuses.length > 0) {
                    const emptyMsg = listEl.querySelector('p.italic');
                    if (emptyMsg) emptyMsg.remove();
                } else if (listEl.children.length === 0) {
                    listEl.innerHTML = '<p class="text-slate-500 text-center italic mt-4">No active announcements channels.</p>';
                    return;
                }

                // 3. Create or Update / Re-order
                activeBuses.forEach(bus => {
                    const containerId = `bus-container-${bus.id}`;
                    let container = document.getElementById(containerId);
                    const busStr = bus.bus_no || bus.id;

                    if (!container) {
                        // CREATE NEW
                        container = document.createElement('div');
                        container.className = "border border-slate-700 rounded-xl overflow-hidden mb-2 transition-all";
                        container.id = containerId;

                        // Header (Create initial structure)
                        const header = document.createElement('div');
                        header.className = "flex items-center justify-between p-4 bg-slate-800/80 hover:bg-slate-800 cursor-pointer";
                        header.onclick = () => toggleBusSection(bus.id);
                        container.appendChild(header);

                        // Content Area
                        const content = document.createElement('div');
                        content.id = `content-${bus.id}`;
                        content.className = "hidden bg-slate-900/50 p-4 space-y-3 min-h-[50px]";
                        content.innerHTML = '<div class="text-center text-xs text-slate-500 py-2"><span class="animate-pulse">Loading messages...</span></div>';
                        container.appendChild(content);
                    }

                    // UPDATE CONTENT (Header) - Safe to overwrite internal HTML of header
                    // We preserve the header element itself, so onclick is safe.
                    const header = container.firstElementChild;
                    const isContentOpen = !container.lastElementChild.classList.contains('hidden');

                    header.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-900/50 flex items-center justify-center text-xs">üöå</div>
                        <span class="font-bold text-slate-200 text-sm">${busStr}</span>
                    </div>
                     <div class="flex items-center gap-2">
                        <span class="text-[10px] text-slate-500 italic">${bus.latest_message ? 'Active' : ''}</span>
                        <svg id="arrow-${bus.id}" class="w-5 h-5 text-slate-500 transform transition-transform ${isContentOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                `;

                    // RE-INSERT to ensure sort order (appendChild moves existing node)
                    listEl.appendChild(container);
                });

            }

            window.toggleBusSection = function (busId) {
                // ... (Same) ...
                const content = document.getElementById(`content-${busId}`);
                const arrow = document.getElementById(`arrow-${busId}`);

                if (content.classList.contains('hidden')) {
                    // Open
                    content.classList.remove('hidden');
                    arrow.classList.add('rotate-180');
                    loadMessagesForBus(busId);
                } else {
                    // Close
                    content.classList.add('hidden');
                    arrow.classList.remove('rotate-180');
                }
            }

            function loadMessagesForBus(busId) {
                if (unsubscribeMessages[busId]) return; // Already listening

                const contentDiv = document.getElementById(`content-${busId}`);
                const qMsgs = query(collection(db, "announcements", busId, "messages"), orderBy("timestamp", "desc"), limit(20));

                const unsub = onSnapshot(qMsgs, (snapshot) => {
                    if (snapshot.empty) {
                        contentDiv.innerHTML = '<p class="text-xs text-slate-500 text-center italic">No messages yet.</p>';
                    } else {
                        // Detect NEW messages for notifications
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === "added") {
                                const data = change.doc.data();
                                // Logic: Only notify if timestamp is very recent (< 1 min ago)
                                // This prevents spamming on initial page load (history)
                                if (data.timestamp) {
                                    const diff = new Date() - data.timestamp.toDate();
                                    if (diff < 60000) { // 60 seconds
                                        sendNotification(`üì¢ Alert: ${busId}`, data.message);
                                    }
                                }
                            }
                        });

                        contentDiv.innerHTML = ''; // Clear loading
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            renderMessage(contentDiv, data);
                        });
                    }
                });

                unsubscribeMessages[busId] = unsub;
            }

            function renderMessage(container, data) {
                let dateStr = "Just now";
                if (data.timestamp) {
                    const d = data.timestamp.toDate();
                    dateStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + ', ' + d.toLocaleDateString();
                }

                const item = document.createElement('div');
                item.className = "bg-slate-800/40 border-l-2 border-blue-500 pl-3 py-1";
                item.innerHTML = `
                <p class="text-slate-300 text-sm leading-relaxed mb-1">${data.message}</p>
                <p class="text-[10px] text-slate-500">${dateStr}</p>
            `;
                container.appendChild(item);
            }

            // Sidebar Toggle Logic
            window.toggleSidebar = function () {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('-translate-x-full');
            }

            // --- Driver Directory Logic ---
            const driversOverlay = document.getElementById('drivers-overlay');
            const driverListEl = document.getElementById('driver-list');
            const profileModal = document.getElementById('profile-modal');
            let driversUnsub = null;

            window.openDrivers = function () {
                driversOverlay.classList.remove('hidden');
                if (window.innerWidth < 768) toggleSidebar();
                fetchDrivers();
            }

            window.closeDrivers = function () {
                driversOverlay.classList.add('hidden');
                if (driversUnsub) driversUnsub(); // Stop listening when closed
            }

            function fetchDrivers() {
                const q = query(collection(db, "drivers"), orderBy("name"));

                driversUnsub = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        driverListEl.innerHTML = '<p class="text-slate-500 text-center italic mt-10">No registered drivers found.</p>';
                        return;
                    }

                    driverListEl.innerHTML = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const card = document.createElement('div');
                        card.className = "bg-slate-800/60 p-4 rounded-xl border border-slate-700 flex items-center justify-between hover:bg-slate-800 hover:border-emerald-500/50 transition-all cursor-pointer group";
                        card.onclick = () => showProfile(data);

                        card.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">
                                üëÆ‚Äç‚ôÇÔ∏è
                            </div>
                            <div>
                                <h3 class="text-white font-bold text-sm">${data.name || 'Unknown Driver'}</h3>
                                <p class="text-[10px] text-slate-400">Tap to view info</p>
                            </div>
                        </div>
                        <div class="p-2 bg-emerald-500/10 rounded-full text-emerald-500">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    `;
                        driverListEl.appendChild(card);
                    });
                });
            }

            window.showProfile = function (data) {
                document.getElementById('profile-name').textContent = data.name || "Driver";
                document.getElementById('profile-mobile').textContent = data.mobile || "N/A";
                document.getElementById('profile-call-btn').href = `tel:${data.mobile}`;
                profileModal.classList.remove('hidden');
            }

            window.closeProfile = function () {
                profileModal.classList.add('hidden');
            }
        </script>

        <script>
            // Initialize Map
            const map = L.map('map', { zoomControl: false }).setView([20.2961, 85.8245], 13);
            window.map = map;

            L.control.zoom({ position: 'bottomright' }).addTo(map);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            const socket = io();

            // GPS & Routing State
            let userMarker = null;
            let routeLine = null;
            let targetBusId = null;
            let userLat = null, userLng = null;
            const tripCard = document.getElementById('trip-info-card');
            const tripEta = document.getElementById('trip-eta');
            const tripDist = document.getElementById('trip-dist');

            // User Location Icon
            const userIcon = L.divIcon({
                className: 'custom-user-icon',
                html: `<div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-lg pulse-ring"></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });

            // Robust Geolocation Handling
            let watchId = null;

            // UI Helpers
            const gpsDot = document.getElementById('gps-dot');
            const gpsText = document.getElementById('gps-text');
            const serverDot = document.getElementById('server-dot');
            const serverText = document.getElementById('server-text');

            // Socket Connection Status
            socket.on('connect', () => {
                if (serverDot && serverText) {
                    serverDot.className = "w-2 h-2 rounded-full bg-green-500";
                    serverText.textContent = "Server: Live";
                }
            });

            socket.on('disconnect', () => {
                if (serverDot && serverText) {
                    serverDot.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                    serverText.textContent = "Server: Offline";
                }
            });

            function updateGpsStatus(state, msg) {
                if (!gpsText || !gpsDot) return;
                gpsText.textContent = msg;

                if (state === 'searching') {
                    gpsDot.className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
                } else if (state === 'active') {
                    gpsDot.className = "w-2 h-2 rounded-full bg-green-500";
                } else if (state === 'error') {
                    gpsDot.className = "w-2 h-2 rounded-full bg-red-500";
                }
            }

            function startLocationTracking(highAccuracy = true) {
                if (watchId) navigator.geolocation.clearWatch(watchId);

                // Fail fast on High Accuracy (Indoor fix), give more time for Low Accuracy
                // usage: startLocationTracking(true) -> tries high acc, if fail -> tries low acc
                const gpsTimeout = highAccuracy ? 5000 : 30000;
                const maxAge = highAccuracy ? 0 : Infinity; // Accept any cached position for low accuracy

                const options = {
                    enableHighAccuracy: highAccuracy,
                    timeout: gpsTimeout,
                    maximumAge: maxAge
                };

                console.log(`Starting GPS (High Acc: ${highAccuracy}, Timeout: ${gpsTimeout}ms)...`);
                updateGpsStatus('searching', `GPS: Locating (${highAccuracy ? 'High' : 'Low'})...`);

                watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        // Success
                        userLat = pos.coords.latitude;
                        userLng = pos.coords.longitude;
                        updateUserMarker(userLat, userLng);
                        updateGpsStatus('active', 'GPS: Active');

                        if (targetBusId) updateRoute();

                        // Hide error card if visible
                        const tripDist = document.getElementById('trip-dist');
                        if (tripDist && tripDist.textContent.includes("GPS")) {
                            document.getElementById('trip-info-card').classList.add('hidden');
                        }
                    },
                    (err) => {
                        console.warn(`GPS Error (${highAccuracy ? 'High' : 'Low'} Acc):`, err);

                        // If High Accuracy fails (Timeout/Error), try Low Accuracy automatically
                        if (highAccuracy) {
                            console.log("High accuracy failed, switching to low accuracy...");
                            startLocationTracking(false);
                            return;
                        }

                        // Show Error to User
                        updateGpsStatus('error', 'GPS: Failed');

                        const tripCard = document.getElementById('trip-info-card');
                        const tripDist = document.getElementById('trip-dist');
                        const tripEta = document.getElementById('trip-eta');

                        tripCard.classList.remove('hidden');
                        tripEta.textContent = "‚ö†Ô∏è";

                        if (err.code === 1) tripDist.textContent = "GPS Access Denied";
                        else if (err.code === 2) tripDist.textContent = "Location Unavailable";
                        else if (err.code === 3) tripDist.textContent = "GPS Signal Weak";
                        else tripDist.textContent = "GPS Error";
                    },
                    options
                );
            }

            // Initialize Geolocation
            if (navigator.geolocation) {
                // Start with Low Accuracy (Wifi/IP) for instant results
                // High Accuracy is often blocked/slow indoors
                startLocationTracking(false);
            } else {
                console.error("Browser does not support Geolocation");
            }

            function updateUserMarker(lat, lng) {
                if (userMarker) {
                    userMarker.setLatLng([lat, lng]);
                } else {
                    userMarker = L.marker([lat, lng], { icon: userIcon, zIndexOffset: 1000 }).addTo(map);
                }
            }

            // Routing Machine Control
            let routingControl = null;

            function startTrackingRoute(busId) {
                // Allow re-clicking to refresh UI even if already selected
                targetBusId = busId;
                tripCard.classList.remove('hidden');
                updateRoute();
            }

            function stopTrackingRoute() {
                targetBusId = null;
                tripCard.classList.add('hidden');

                if (routingControl) {
                    map.removeControl(routingControl);
                    routingControl = null;
                }
                // Remove legacy lines just in case
                if (routeLine) {
                    map.removeLayer(routeLine);
                    routeLine = null;
                }
                // Remove dashed fallback line
                if (window.fallbackLine) {
                    map.removeLayer(window.fallbackLine);
                    window.fallbackLine = null;
                }
            }

            function updateRoute() {
                if (!targetBusId || !markers[targetBusId]) return;

                // If we don't have user location yet
                if (!userLat) {
                    tripEta.textContent = "--";
                    tripDist.textContent = "Locating you...";
                    tripCard.classList.remove('hidden');

                    // Force GPS update check if stuck
                    if (!watchId) startLocationTracking(false);
                    return;
                }

                const busMarker = markers[targetBusId];

                // UI Update for Offline Status
                if (busMarker.isOffline) {
                    tripCard.classList.add('grayscale');
                    tripEta.style.color = '#94a3b8'; // Slate-400
                    tripDist.innerText += " (Offline)";
                } else {
                    tripCard.classList.remove('grayscale');
                    tripEta.style.color = 'white';
                }

                const busLatLng = busMarker.getLatLng();

                // Swap: From Bus (Source) -> To User (Destination)
                const waypoints = [
                    L.latLng(busLatLng.lat, busLatLng.lng),
                    L.latLng(userLat, userLng)
                ];

                // Perform Instant Estimate (Haversine) & Draw Visual Fallback
                runFallbackRouting(busLatLng); // Uses simple line + math immediately

                // If control exists, update waypoints (attempting road match)
                if (routingControl) {
                    if (window.routingTimer) clearTimeout(window.routingTimer);
                    startRoutingTimer(busLatLng);
                    routingControl.setWaypoints(waypoints);
                } else {
                    // Initialize new control
                    tripCard.classList.remove('hidden');

                    if (window.routingTimer) clearTimeout(window.routingTimer);
                    startRoutingTimer(busLatLng);

                    try {
                        routingControl = L.Routing.control({
                            waypoints: waypoints,
                            router: L.Routing.osrmv1({
                                serviceUrl: 'https://router.project-osrm.org/route/v1',
                                profile: 'driving',
                                timeout: 5000,
                                routingOptions: {
                                    alternatives: false,
                                    steps: false,
                                    overview: 'full'
                                }
                            }),
                            lineOptions: {
                                styles: [{ color: '#3b82f6', opacity: 0.8, weight: 6 }]
                            },
                            createMarker: function () { return null; },
                            addWaypoints: false,
                            draggableWaypoints: false,
                            fitSelectedRoutes: false,
                            show: false
                        }).addTo(map);

                        // Listeners
                        routingControl.on('routesfound', function (e) {
                            // Success! Remove dashed fallback line
                            if (window.fallbackLine) {
                                map.removeLayer(window.fallbackLine);
                                window.fallbackLine = null;
                            }
                            if (window.routingTimer) clearTimeout(window.routingTimer);

                            const routes = e.routes;
                            if (!routes || routes.length === 0) return;

                            const summary = routes[0].summary;
                            const durationMins = Math.ceil(summary.totalTime / 60);
                            const distanceKm = (summary.totalDistance / 1000).toFixed(1);

                            tripEta.textContent = `${durationMins} min`;
                            tripDist.textContent = `(${distanceKm} km)`;
                        });

                        routingControl.on('routingerror', function (e) {
                            if (window.routingTimer) clearTimeout(window.routingTimer);
                            // Do nothing visually, fallback line is already there from start
                            console.warn("Routing failed, keeping fallback line.");
                        });

                    } catch (err) {
                        console.error("Routing Init Error:", err);
                        // Fallback line already drawn
                    }
                }
            }

            // --- Routing Timeouts Helpers ---
            function startRoutingTimer(busLatLng) {
                window.routingTimer = setTimeout(() => {
                    console.warn("OSRM Timeout (5s) - Keeping Direct Line");
                    // Stop the routing spinner effect if any (not implemented, but good practice)
                    // We just let the dashed line stay.
                }, 5000);
            }

            function runFallbackRouting(busLatLng) {
                const dist = map.distance([userLat, userLng], busLatLng);
                const distKm = (dist / 1000).toFixed(1);
                const timeMins = Math.ceil((distKm / 30) * 60);

                tripDist.textContent = `(${distKm} km)`;
                tripEta.textContent = `${timeMins} min`;

                // Draw Dashed Line (Visual Fallback)
                const waypoints = [
                    [userLat, userLng],
                    [busLatLng.lat, busLatLng.lng]
                ];

                if (window.fallbackLine) map.removeLayer(window.fallbackLine);

                window.fallbackLine = L.polyline(waypoints, {
                    color: '#64748b', // Slate-500
                    weight: 4,
                    dashArray: '10, 10', // Dashed
                    opacity: 0.7
                }).addTo(map);
            }


            const markers = {};
            const circles = {};
            let currentFilter = "";
            let offlineResult = null; // Store result from server search if offline

            function createBusIcon(busNo) {
                return L.divIcon({
                    className: 'custom-div-icon',
                    // Orange Icon for Bus
                    html: `<div style="position: relative;">
                        <div style="background-color: #f59e0b; width: 44px; height: 44px; border-radius: 50%; border: 3px solid #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                            <span style="font-size: 22px;">üöå</span>
                        </div>
                        <div style="background: #1e293b; color: white; padding: 2px 8px; border-radius: 6px; font-weight: bold; font-size: 10px; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); white-space: nowrap; border: 1px solid #475569;">
                            ${busNo}
                        </div>
                       </div>`,
                    iconSize: [44, 44],
                    iconAnchor: [22, 22]
                });
            }

            function createEvIcon(busNo) {
                return L.divIcon({
                    className: 'custom-div-icon',
                    // Green Icon for EV
                    html: `<div style="position: relative;">
                        <div style="background-color: #10b981; width: 44px; height: 44px; border-radius: 50%; border: 3px solid #fff; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                            <span style="font-size: 22px;">‚ö°</span>
                        </div>
                        <div style="background: #064e3b; color: white; padding: 2px 8px; border-radius: 6px; font-weight: bold; font-size: 10px; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); white-space: nowrap; border: 1px solid #10b981;">
                            EV Shuttle
                        </div>
                       </div>`,
                    iconSize: [44, 44],
                    iconAnchor: [22, 22]
                });
            }

            const trackInput = document.getElementById('trackInput');
            const statusP = document.getElementById('tracking-status');

            function quickSearch(busNo) {
                trackInput.value = busNo;
                setFilter();
            }

            function setFilter() {
                const val = trackInput.value.trim().toUpperCase();
                currentFilter = val;
                offlineResult = null; // Reset offline result

                // Logic to auto-select matching bus
                let foundSid = null;
                if (val) {
                    for (let sid in markers) {
                        if (markers[sid]._busNo === val) {
                            foundSid = sid;
                            break;
                        }
                    }

                    if (foundSid) {
                        startTrackingRoute(foundSid);
                        // Optional: Center map
                        // map.setView(markers[foundSid].getLatLng(), 15);
                    }

                    statusP.innerHTML = `<span>Filtered:</span> <b class="text-white">${val}</b> <button onclick="clearFilter()" class="ml-auto text-red-400 hover:text-red-300 text-xs underline">Reset</button>`;
                    statusP.classList.remove('hidden');

                    // Server Search (for offline/history check)
                    socket.emit('search_bus', val);
                } else {
                    clearFilter();
                    stopTrackingRoute();
                }
                refreshMap(); // Refresh immediately for local filtering
            }

            window.clearFilter = function () {
                currentFilter = "";
                trackInput.value = "";
                offlineResult = null;
                statusP.classList.add('hidden');
                stopTrackingRoute();
                refreshMap();
            }

            // Listener for server search results
            socket.on('search_result', (data) => {
                if (data.status === 'offline' || data.status === 'not_found') {
                    offlineResult = data;
                    updateBusList(); // Force update to show offline card
                }
            });

            function refreshMap() {
                for (const [sid, marker] of Object.entries(markers)) {
                    if (shouldShow(marker._busNo)) {
                        if (!map.hasLayer(marker)) map.addLayer(marker);
                        if (circles[sid] && !map.hasLayer(circles[sid])) map.addLayer(circles[sid]);
                    } else {
                        if (map.hasLayer(marker)) map.removeLayer(marker);
                        if (circles[sid] && map.hasLayer(circles[sid])) map.removeLayer(circles[sid]);
                    }
                }
                updateBusList();
            }

            function shouldShow(busNo) {
                // EVs are "Base Service" - Always show them regardless of filter
                if (busNo.startsWith("EV-")) return true;

                if (!currentFilter) return true;
                return busNo.includes(currentFilter);
            }



            function renderBusCard(sid, marker) {
                const isEv = marker._busNo.startsWith("EV-");
                const typeIcon = isEv ? "‚ö°" : "üöå";
                const typeColor = isEv ? "text-emerald-400" : "text-blue-100";
                const iconBg = isEv ? "bg-emerald-900/50" : "bg-blue-900/50";
                const activeColor = isEv ? "text-emerald-400" : "text-green-400";
                const activeBg = isEv ? "bg-emerald-500" : "bg-green-500";

                // Mask EV ID
                const displayId = isEv ? "Campus Shuttle" : marker._busNo;

                if (marker.isOffline) {
                    // OFFLINE CARD
                    const timeLabel = timeAgo(marker.disconnectTime);
                    return `
                <div class="group flex items-center justify-between p-3 bg-slate-800/20 rounded-xl border border-dashed border-slate-600 grayscale opacity-80 cursor-pointer" onclick="zoomToBus('${sid}')">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-lg">üò¥</div>
                        <div>
                            <p class="font-bold text-sm text-slate-300">${displayId}</p>
                            <p class="text-[10px] text-slate-500 font-bold">
                                OFFLINE ‚Ä¢ ${timeLabel}
                            </p>
                        </div>
                    </div>
                </div>
                `;
                } else {
                    // ACTIVE CARD
                    return `
                <div class="group flex items-center justify-between p-3 bg-slate-800/50 rounded-xl border border-slate-700 hover:border-blue-500/50 transition-all cursor-pointer" onclick="zoomToBus('${sid}')">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full ${iconBg} flex items-center justify-center text-lg">${typeIcon}</div>
                        <div>
                            <p class="font-bold text-sm ${typeColor}">${displayId}</p>
                            <p class="text-[10px] ${activeColor} font-bold flex items-center gap-1">
                                <span class="w-1.5 h-1.5 rounded-full ${activeBg} animate-pulse"></span>
                                ACTIVE NOW
                            </p>
                        </div>
                    </div>
                    <div class="text-xs text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        LOCATE ‚Üí
                    </div>
                </div>
                `;
                }
            }

            function updateBusList() {
                const listDiv = document.getElementById('bus-list');
                let visibleCount = 0;
                let html = '';

                // Separate Lists
                let evHtml = '';
                let busHtml = '';
                let hasEv = false;
                let hasBus = false;

                for (const [sid, marker] of Object.entries(markers)) {
                    if (shouldShow(marker._busNo)) {
                        visibleCount++;
                        const card = renderBusCard(sid, marker);
                        if (marker._busNo.startsWith("EV-")) {
                            evHtml += card;
                            hasEv = true;
                        } else {
                            busHtml += card;
                            hasBus = true;
                        }
                    }
                }

                if (hasEv) {
                    html += `<div class="mb-2"><h3 class="text-[10px] bg-emerald-900/30 text-emerald-400 px-3 py-1 rounded-lg font-bold uppercase tracking-wider mb-2 border border-emerald-900/50">‚ö° EV Shuttles</h3><div class="space-y-2">${evHtml}</div></div>`;
                }

                if (hasBus) {
                    html += `<div class="mb-2"><h3 class="text-[10px] bg-blue-900/30 text-blue-400 px-3 py-1 rounded-lg font-bold uppercase tracking-wider mb-2 border border-blue-900/50">üöå Campus Buses</h3><div class="space-y-2">${busHtml}</div></div>`;
                }

                // Empty States
                if (visibleCount === 0) {
                    if (currentFilter && !offlineResult) {
                        html = '<p class="text-xs text-slate-500 text-center py-4 italic">No matching vehicle found.</p>';
                    } else if (!currentFilter) {
                        html = '<p class="text-xs text-slate-500 text-center py-4 italic">No active vehicles.</p>';
                    }
                }

                listDiv.innerHTML = html;
            }

            window.zoomToBus = function (sid) {
                if (markers[sid] && map.hasLayer(markers[sid])) {
                    const ll = markers[sid].getLatLng();
                    map.flyTo(ll, 16);
                    startTrackingRoute(sid); // Start Ola-style tracking
                }
            };

            socket.on('update_buses', (buses) => {
                for (const [sid, data] of Object.entries(buses)) updateMarker(sid, data);
                updateBusList();
            });

            socket.on('update_bus', (msg) => {
                updateMarker(msg.id, msg.data);
                updateBusList();
            });

            function createOfflineBusIcon(busNo) {
                return L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="position: relative; filter: grayscale(100%); opacity: 0.7;">
                        <div style="background-color: #64748b; width: 40px; height: 40px; border-radius: 50%; border: 3px solid #1e293b; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.5);">
                            <span style="font-size: 20px;">üöå</span>
                        </div>
                        <div style="background: #1e293b; color: white; padding: 2px 8px; border-radius: 6px; font-weight: bold; font-size: 10px; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); white-space: nowrap; border: 1px solid #475569; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                            ${busNo}
                        </div>
                       </div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
            }

            socket.on('bus_disconnected', (sid) => {
                if (markers[sid]) {
                    const marker = markers[sid];
                    marker.isOffline = true;
                    marker.disconnectTime = new Date();

                    // Update styling to offline
                    marker.setIcon(createOfflineBusIcon(marker._busNo));

                    // Remove accuracy circle
                    if (circles[sid]) {
                        map.removeLayer(circles[sid]);
                        delete circles[sid];
                    }

                    console.log(`Bus ${marker._busNo} went offline at ${marker.disconnectTime.toLocaleTimeString()}`);
                    updateBusList();
                }
            });

            // Helper to format "X min ago"
            function timeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                const interval = Math.floor(seconds / 60);
                if (interval < 1) return "Just now";
                if (interval === 1) return "1 min ago";
                return interval + " mins ago";
            }

            // Auto-update times every minute
            setInterval(updateBusList, 60000);

            function updateMarker(sid, data) {
                if (!data) return;
                const { lat, lng, bus_no, accuracy } = data;

                // FIX: Remove 'Ghost Markers' (Duplicate bus_no with different SID)
                for (const [existingSid, marker] of Object.entries(markers)) {
                    if (marker._busNo === bus_no && existingSid !== sid) {
                        map.removeLayer(markers[existingSid]);
                        delete markers[existingSid];
                        if (circles[existingSid]) {
                            map.removeLayer(circles[existingSid]);
                            delete circles[existingSid];
                        }
                    }
                }

                if (markers[sid]) {
                    const marker = markers[sid];
                    if (marker.isOffline) {
                        // Waking up! Reset to active state
                        marker.isOffline = false;
                        const isEv = bus_no.startsWith('EV-');
                        marker.setIcon(isEv ? createEvIcon(bus_no) : createBusIcon(bus_no));
                        console.log(`Bus ${bus_no} is back online!`);
                    }
                    marker.setLatLng([lat, lng]);
                    marker._busNo = bus_no;
                    if (circles[sid]) {
                        circles[sid].setLatLng([lat, lng]);
                        circles[sid].setRadius(accuracy || 0);
                    }
                } else {
                    const isEv = bus_no.startsWith('EV-');
                    const marker = L.marker([lat, lng], { icon: isEv ? createEvIcon(bus_no) : createBusIcon(bus_no) });
                    marker._busNo = bus_no;

                    // Click to track route
                    marker.on('click', () => {
                        startTrackingRoute(sid);
                    });

                    markers[sid] = marker;

                    const circle = L.circle([lat, lng], {
                        radius: accuracy || 0,
                        color: '#60a5fa', // Blue-400
                        fillColor: '#3b82f6',
                        fillOpacity: 0.1,
                        weight: 1,
                        className: 'animate-pulse'
                    });
                    circles[sid] = circle;

                    if (shouldShow(bus_no)) {
                        marker.addTo(map);
                        circle.addTo(map);
                    }
                }

                // Update route if this is the target bus
                if (targetBusId === sid) {
                    updateRoute();
                }
            }
        </script>

        <!-- Chat Bot Widget -->
        <!-- Floating Button -->
        <button onclick="toggleChat()"
            class="fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full shadow-2xl flex items-center justify-center transition-all hover:scale-110 z-[2000] border-2 border-indigo-400">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                </path>
            </svg>
        </button>

        <!-- Chat Window -->
        <div id="chat-window"
            class="fixed bottom-24 right-4 w-80 sm:w-96 bg-slate-900/95 backdrop-blur-xl border border-slate-700 rounded-2xl shadow-2xl z-[2000] transform transition-all duration-300 translate-y-10 opacity-0 pointer-events-none flex flex-col overflow-hidden max-h-[500px]">
            <!-- Header -->
            <div class="bg-indigo-600 p-4 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center text-lg">ü§ñ</div>
                    <div>
                        <h3 class="font-bold text-white text-sm">Campus Assistant</h3>
                        <div class="flex items-center gap-1.5">
                            <span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span>
                            <span class="text-[10px] text-indigo-100 font-bold">Online</span>
                        </div>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-white/70 hover:text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Messages Area -->
            <div id="chat-messages"
                class="flex-1 overflow-y-auto p-4 space-y-3 min-h-[300px] max-h-[300px] bg-slate-900/50">
                <!-- Welcome Message -->
                <div class="flex gap-2 items-start">
                    <div
                        class="w-6 h-6 rounded-full bg-indigo-600 flex-shrink-0 flex items-center justify-center text-xs">
                        ü§ñ
                    </div>
                    <div class="bg-slate-800 p-3 rounded-2xl rounded-tl-sm text-sm text-slate-200 shadow-md">
                        Hi! I can help you navigate the app. Ask me about tracking, bus icons, or what "offline" means!
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-3 border-t border-slate-700 bg-slate-800/50">
                <form onsubmit="handleChat(event)" class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Type a question..."
                        class="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-4 py-2 text-sm text-white focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 placeholder-slate-500">
                    <button type="submit"
                        class="bg-indigo-600 hover:bg-indigo-500 text-white p-2 rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </form>
            </div>
        </div>

        <script>
            // Chat Bot Logic
            let isChatOpen = false;

            function toggleChat() {
                const windowEl = document.getElementById('chat-window');
                isChatOpen = !isChatOpen;

                if (isChatOpen) {
                    windowEl.classList.remove('translate-y-10', 'opacity-0', 'pointer-events-none');
                    document.getElementById('chat-input').focus();
                } else {
                    windowEl.classList.add('translate-y-10', 'opacity-0', 'pointer-events-none');
                }
            }

            async function handleChat(e) {
                e.preventDefault();
                const input = document.getElementById('chat-input');
                const msg = input.value.trim();
                if (!msg) return;

                // User Message
                addMessage(msg, 'user');
                input.value = '';

                // Bot Response (Real Llama 3)
                showTypingIndicator();

                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: msg })
                    });
                    const data = await response.json();
                    removeTypingIndicator();
                    addMessage(data.response, 'bot');
                } catch (err) {
                    console.error(err);
                    removeTypingIndicator();
                    addMessage("I'm having a little trouble connecting to the server. Please try again.", 'bot');
                }
            }

            function addMessage(text, sender) {
                const container = document.getElementById('chat-messages');
                const isBot = sender === 'bot';

                const html = `
                <div class="flex gap-2 items-start ${isBot ? '' : 'flex-row-reverse'}">
                    <div class="w-6 h-6 rounded-full ${isBot ? 'bg-indigo-600' : 'bg-slate-500'} flex-shrink-0 flex items-center justify-center text-xs">
                        ${isBot ? 'ü§ñ' : 'üë§'}
                    </div>
                    <div class="${isBot ? 'bg-slate-800 rounded-tl-sm' : 'bg-indigo-600 rounded-tr-sm'} p-3 rounded-2xl text-sm ${isBot ? 'text-slate-200' : 'text-white'} shadow-md">
                        ${text}
                    </div>
                </div>
            `;
                container.insertAdjacentHTML('beforeend', html);
                container.scrollTop = container.scrollHeight;
            }

            function showTypingIndicator() {
                const container = document.getElementById('chat-messages');
                const html = `
                <div id="typing-indicator" class="flex gap-2 items-start">
                    <div class="w-6 h-6 rounded-full bg-indigo-600 flex-shrink-0 flex items-center justify-center text-xs">ü§ñ</div>
                    <div class="bg-slate-800 p-3 rounded-2xl rounded-tl-sm text-sm text-slate-200 shadow-md flex gap-1 items-center h-10">
                        <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></span>
                        <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                    </div>
                </div>
            `;
                container.insertAdjacentHTML('beforeend', html);
                container.scrollTop = container.scrollHeight;
            }

            function removeTypingIndicator() {
                const el = document.getElementById('typing-indicator');
                if (el) el.remove();
            }


            // --- Schedule Logic ---
            window.openSchedule = function () {
                // Legacy support or direct call if needed
                const btn = document.getElementById('btn-open-sched');
                if (btn) btn.click();
            }

            // Bind Event Listener (Robust Binding)
            const btnSched = document.getElementById('btn-open-sched');
            if (btnSched) {
                btnSched.addEventListener('click', () => {
                    console.log("Schedule Button Clicked (Event)");
                    const overlay = document.getElementById('schedule-overlay');
                    if (!overlay) return alert("Error: Overlay missing");

                    overlay.classList.remove('hidden');
                    // Use optional chaining for toggleSidebar
                    if (window.innerWidth < 768 && window.toggleSidebar) window.toggleSidebar();

                    fetchSchedules();
                });
            } else {
                console.error("Schedule Button ID not found in DOM");
            }

            window.closeSchedule = function () {
                const overlay = document.getElementById('schedule-overlay');
                if (overlay) overlay.classList.add('hidden');
            }

            function fetchSchedules() {
                const listEl = document.getElementById('schedule-list');
                if (!listEl) return;

                listEl.innerHTML = '<p class="text-slate-500 text-center italic mt-10 animate-pulse">Loading schedules...</p>';

                const q = query(collection(db, "schedules"), orderBy("last_update", "desc"));

                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        listEl.innerHTML = '<p class="text-slate-500 text-center italic mt-10">No schedules published yet.</p>';
                        return;
                    }

                    listEl.innerHTML = '';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const busNo = data.bus_no || doc.id;
                        const containerId = `sched-box-${doc.id}`;

                        const div = document.createElement('div');
                        div.className = "border border-slate-700 rounded-xl overflow-hidden mb-2";
                        div.id = containerId;

                        div.innerHTML = `
                         <div class="flex items-center justify-between p-4 bg-slate-800/80 hover:bg-slate-800 cursor-pointer" onclick="loadBusSchedule('${doc.id}')">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-purple-900/50 flex items-center justify-center text-xs">üìÖ</div>
                                <span class="font-bold text-slate-200 text-sm">Bus ${busNo}</span>
                            </div>
                            <svg id="arrow-sched-${doc.id}" class="w-5 h-5 text-slate-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                        <div id="sched-content-${doc.id}" class="hidden bg-slate-900/50 p-4 space-y-3 min-h-[50px]">
                            <p class="text-xs text-slate-500 animate-pulse">Loading dates...</p>
                        </div>
                    `;
                        listEl.appendChild(div);
                    });
                }, (error) => {
                    console.error("Error fetching schedules:", error);
                    listEl.innerHTML = '<p class="text-red-400 text-center text-xs mt-10">Error loading schedules.</p>';
                });
            }

            window.loadBusSchedule = function (busId) {
                console.log("Loading schedule for:", busId);
                const content = document.getElementById(`sched-content-${busId}`);
                const arrow = document.getElementById(`arrow-sched-${busId}`);

                if (!content.classList.contains('hidden')) {
                    content.classList.add('hidden');
                    arrow.classList.remove('rotate-180');
                    return;
                }

                // Open
                content.classList.remove('hidden');
                arrow.classList.add('rotate-180');

                // Fetch Dates
                const today = new Date().toISOString().split('T')[0];
                const q = query(collection(db, "schedules", busId, "dates"), orderBy("__name__"));

                getDocs(q).then(snapshot => {
                    content.innerHTML = '';

                    const validDocs = snapshot.docs.filter(d => d.id >= today);

                    if (validDocs.length === 0) {
                        content.innerHTML = '<p class="text-xs text-slate-500 text-center italic">No upcoming schedule.</p>';
                        return;
                    }

                    validDocs.forEach(d => {
                        const dateData = d.data();
                        const timings = dateData.timings || [];
                        const niceDate = new Date(d.id).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });

                        const row = document.createElement('div');
                        row.className = "mb-3 last:mb-0";

                        let timelineHTML = '';
                        timings.forEach(t => {
                            timelineHTML += `
                            <div class="flex items-start gap-3 relative pb-4 last:pb-0 border-l border-slate-700 ml-2 pl-4">
                                <div class="absolute -left-[5px] top-1.5 w-2.5 h-2.5 rounded-full bg-purple-500 border-2 border-slate-900"></div>
                                <div>
                                    <p class="text-white font-bold font-mono text-sm">${t.time}</p>
                                    <p class="text-slate-400 text-xs">${t.note}</p>
                                </div>
                            </div>
                         `;
                        });

                        row.innerHTML = `
                        <p class="text-[10px] uppercase font-bold text-slate-500 mb-2 sticky top-0 bg-slate-900/90 py-1 z-10">${niceDate}</p>
                        <div class="pl-2">${timelineHTML}</div>
                     `;
                        content.appendChild(row);
                    });
                }).catch(err => {
                    console.error("Error loading dates:", err);
                    content.innerHTML = '<p class="text-xs text-red-400">Failed to load.</p>';
                });
            }
        </script>

</html>