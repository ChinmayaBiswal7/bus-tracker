<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver Console | Campus Ride</title>

    <!-- Core Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="/static/pwa-update.js"></script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: #0f172a;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Map Layer */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        /* Bottom Sheet */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 2rem 2rem 0 0;
            box-shadow: 0 -10px 50px rgba(0, 0, 0, 0.6);
            z-index: 50;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        /* Sheet States */
        .sheet-minimized {
            transform: translateY(calc(100% - 130px));
        }

        /* Show only top 130px */
        .sheet-expanded {
            transform: translateY(0);
        }

        /* Handle */
        .sheet-handle-area {
            width: 100%;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .sheet-handle {
            width: 48px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 100px;
        }

        /* Gauge */
        .gauge-container {
            position: relative;
            width: 100px;
            height: 50px;
            margin: 0 auto;
        }

        .gauge-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-bottom-color: transparent;
            border-left-color: transparent;
            transform: rotate(135deg);
        }

        .gauge-fill {
            position: absolute;
            top: 0;
            left: 0;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 8px solid transparent;
            border-top-color: #3b82f6;
            border-right-color: #3b82f6;
            transform: rotate(45deg);
            transition: transform 0.5s;
        }

        /* Animations */
        .pulse-ring {
            animation: pulse-blue 2s infinite;
        }

        @keyframes pulse-blue {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 15px rgba(59, 130, 246, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        .loader {
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body id="main-body" style="display: none;">

    <!-- Auth Guard -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        const guardConfig = { apiKey: "AIzaSyAW7XS_Q_Kdh2eiYEaKBEHvZDpOk7-ynDg", authDomain: "bustracker-c0af6.firebaseapp.com", projectId: "bustracker-c0af6", storageBucket: "bustracker-c0af6.firebasestorage.app", messagingSenderId: "103145940746", appId: "1:103145940746:web:80a8444bff23e75b94fcf3", measurementId: "G-PKF72NB657" };
        const guardApp = initializeApp(guardConfig); window.firebaseApp = guardApp; const auth = getAuth(guardApp);
        onAuthStateChanged(auth, (user) => { if (user) { document.getElementById('main-body').style.display = 'block'; window.initMap(); } else { window.location.href = '/login?role=driver'; } });
        window.logout = function () { auth.signOut().then(() => window.location.href = '/'); }
    </script>

    <!-- MAP -->
    <div id="map"></div>

    <!-- TOP BAR (Float) -->
    <div class="fixed top-0 left-0 right-0 p-4 z-40 flex justify-between items-start pointer-events-none">
        <div
            class="bg-slate-900/80 backdrop-blur-md px-4 py-2 rounded-full flex items-center gap-2 pointer-events-auto border border-white/10">
            <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
            <span id="serverStatus" class="text-[10px] font-bold text-slate-300 uppercase tracking-wider">OFFLINE</span>
        </div>
        <button onclick="logout()"
            class="pointer-events-auto w-9 h-9 bg-slate-900/80 rounded-full flex items-center justify-center text-slate-400 hover:text-white border border-white/10">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                </path>
            </svg>
        </button>
    </div>


    <!-- BOTTOM SHEET -->
    <div id="dashboard-sheet" class="bottom-sheet sheet-expanded">

        <!-- Drag Handle -->
        <div class="sheet-handle-area" onclick="toggleSheet()">
            <div class="sheet-handle max-w-[40px]"></div>
        </div>

        <!-- 1. HEADER / MINIMIZED VIEW (Always Visible) -->
        <div class="px-6 pb-2 pt-1 flex justify-between items-center shrink-0 h-[80px]">

            <!-- Context: Active Route -->
            <div>
                <h1 class="text-white font-bold text-lg leading-tight" id="header-title">Setup Route</h1>
                <p class="text-[10px] text-slate-400 font-mono" id="header-subtitle">Select Bus No.</p>
            </div>

            <!-- Mini Gauge (Only visible when driving?) No, always keep mini status -->
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <div class="text-2xl font-bold text-blue-500 mono leading-none"><span id="mini-speed">0</span></div>
                    <div class="text-[8px] text-slate-500 uppercase">km/h</div>
                </div>

                <!-- Toggle Button (Changes based on state) -->
                <button id="toggleBtn"
                    class="bg-blue-600 hover:bg-blue-500 text-white w-12 h-12 rounded-xl flex items-center justify-center shadow-lg shadow-blue-900/30 transition-all active:scale-95">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z" />
                    </svg> <!-- GPS Start Icon -->
                </button>
            </div>
        </div>

        <!-- 2. EXPANDED CONTENT (Scrollable) -->
        <div class="flex-1 overflow-y-auto px-6 pb-6 pt-2 space-y-4">

            <hr class="border-slate-800 mb-4">

            <!-- Grid Layout -->
            <div class="grid grid-cols-1 gap-4">

                <!-- CONFIG CARD -->
                <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                    <h3 class="text-xs text-slate-400 font-bold uppercase mb-3">Vehicle Configuration</h3>
                    <div class="flex gap-3">
                        <div class="bg-slate-900 rounded-xl p-1 flex border border-slate-700 h-12 shrink-0 relative w-32"
                            id="mode-toggle">
                            <div id="active-blob"
                                class="absolute inset-y-1 left-1 w-[calc(50%-4px)] bg-blue-600 rounded-lg transition-transform duration-300">
                            </div>
                            <button onclick="setMode('BUS')"
                                class="flex-1 relative z-10 text-xs font-bold text-white">BUS</button>
                            <button onclick="setMode('EV')"
                                class="flex-1 relative z-10 text-xs font-bold text-slate-400">EV</button>
                        </div>
                        <input type="text" id="busInput" placeholder="NO."
                            class="w-20 bg-slate-900 border border-slate-700 rounded-xl text-center text-white font-bold text-lg focus:border-blue-500 focus:outline-none uppercase">
                    </div>
                </div>

                <!-- ANNOUNCEMENTS -->
                <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                    <div class="flex justify-between mb-2">
                        <h3 class="text-xs text-slate-400 font-bold uppercase">Broadcast</h3>
                        <span class="text-[10px] text-purple-400">AI Enabled</span>
                    </div>
                    <div class="relative mb-3">
                        <textarea id="announceInput" rows="3"
                            class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-white focus:border-purple-500 focus:outline-none resize-none"
                            placeholder="Alert message..."></textarea>
                        <button id="btnAiAssist"
                            class="absolute bottom-2 right-2 p-1.5 bg-slate-800 hover:bg-purple-600 rounded text-white shadow"><span
                                class="text-xs">✨</span></button>
                    </div>
                    <button id="btnAnnounce"
                        class="w-full py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 font-bold rounded-lg text-sm">Send
                        Alert</button>
                </div>

                <!-- TELEMETRY DETAILS -->
                <div class="bg-slate-800/50 rounded-2xl p-4 border border-slate-700 flex justify-between items-center">
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase">GPS Quality</p>
                        <p id="gps-quality" class="text-sm font-mono text-white font-bold">--</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-500 uppercase">Last Update</p>
                        <p id="last-updated" class="text-sm font-mono text-white text-right">Running...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <!-- APP LOGIC -->
    <script type="module">
        import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // UI REFS
        const sheet = document.getElementById('dashboard-sheet');
        const btnMain = document.getElementById('toggleBtn');
        const headerTitle = document.getElementById('header-title');
        const headerSub = document.getElementById('header-subtitle');
        const busInput = document.getElementById('busInput');
        const miniSpeed = document.getElementById('mini-speed');

        // STATE
        let isSharing = false;
        let map, userMarker, watchId;
        let currentMode = 'BUS';
        let activeBusNo = null;

        // SHEET LOGIC
        window.toggleSheet = function () {
            if (sheet.classList.contains('sheet-expanded')) {
                sheet.classList.replace('sheet-expanded', 'sheet-minimized');
            } else {
                sheet.classList.replace('sheet-minimized', 'sheet-expanded');
            }
        }
        // Auto-minimize on start
        function minimize() { sheet.classList.replace('sheet-expanded', 'sheet-minimized'); }
        function expand() { sheet.classList.replace('sheet-minimized', 'sheet-expanded'); }

        // MODE TOGGLE
        window.setMode = function (mode) {
            if (isSharing) return;
            currentMode = mode;
            const blob = document.getElementById('active-blob');
            const btns = document.getElementById('mode-toggle').querySelectorAll('button');
            if (mode === 'BUS') {
                blob.style.transform = 'translateX(0)';
                btns[0].style.color = 'white'; btns[1].style.color = '#94a3b8';
                busInput.value = ""; busInput.disabled = false;
            } else {
                blob.style.transform = 'translateX(100%)';
                btns[1].style.color = 'white'; btns[0].style.color = '#94a3b8';
                busInput.value = "EV-" + Math.floor(Math.random() * 900 + 100); busInput.disabled = true;
            }
        }

        // DRIVE ACTION
        btnMain.addEventListener('click', (e) => {
            e.stopPropagation(); // Don't toggle sheet
            if (!isSharing) {
                const val = busInput.value.trim().toUpperCase();
                if (!val) return alert("Enter Bus Number");
                startSession(val);
            } else {
                stopSession();
            }
        });

        function startSession(busNo) {
            if (!navigator.geolocation) return alert("No GPS");
            activeBusNo = busNo;
            isSharing = true;

            // UI UPDATES
            btnMain.innerHTML = `<div class="w-4 h-4 bg-white rounded-sm"></div>`; // Stop Stop Square
            btnMain.classList.replace('bg-blue-600', 'bg-red-500');
            headerTitle.textContent = `Bus ${busNo}`;
            headerTitle.classList.add('text-green-400');
            headerSub.textContent = "● LIVE BROADCASTING";

            // Minimize map for navigation
            minimize();

            // GPS
            const opts = { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 };
            watchId = navigator.geolocation.watchPosition(
                (pos) => handleGPS(pos, busNo),
                (err) => console.error(err), opts
            );
        }

        function stopSession() {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            watchId = null;
            isSharing = false;

            const socket = io();
            socket.emit('driver_update', null);

            // RESET
            btnMain.innerHTML = `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>`;
            btnMain.classList.replace('bg-red-500', 'bg-blue-600');
            headerTitle.textContent = "Setup Route";
            headerTitle.classList.remove('text-green-400');
            headerSub.textContent = "Select Bus No.";
            miniSpeed.textContent = "0";

            expand(); // Show config again
            if (map && userMarker) map.removeLayer(userMarker);
        }

        function handleGPS(pos, busNo) {
            const { latitude, longitude, speed, headings, accuracy } = pos.coords;
            const kmh = speed ? Math.round(speed * 3.6) : 0;

            miniSpeed.textContent = kmh;
            document.getElementById('gps-quality').textContent = `±${Math.round(accuracy)}m`;
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();

            if (map) {
                userMarker.setLatLng([latitude, longitude]).addTo(map);
                map.setView([latitude, longitude], 17);
            }

            const socket = io();
            socket.emit('driver_update', { lat: latitude, lng: longitude, speed, headings, bus_no: busNo, accuracy });
        }

        // MAP INIT
        window.initMap = function () {
            if (map) return;
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([20.2961, 85.8245], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);

            const icon = L.divIcon({ className: 'custom-icon', html: `<div class="w-6 h-6 bg-blue-500 rounded-full border-4 border-white shadow-lg pulse-ring"></div>`, iconSize: [24, 24], iconAnchor: [12, 12] });
            userMarker = L.marker([0, 0], { icon: icon });
        }

        // ANNOUNCEMENT (Same logic)
        const btnAi = document.getElementById('btnAiAssist');
        const inputAnnounce = document.getElementById('announceInput');
        const btnSend = document.getElementById('btnAnnounce');

        btnAi.addEventListener('click', async () => {
            // ... AI logic reuse ...
            const text = inputAnnounce.value; if (!text) return;
            btnAi.innerHTML = '...';
            try {
                const res = await fetch('/api/driver/ai-assist', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
                const data = await res.json();
                if (data.response) inputAnnounce.value = data.response;
            } catch (e) { } finally { btnAi.innerHTML = '✨'; }
        });

        btnSend.addEventListener('click', async () => {
            const msg = inputAnnounce.value;
            if (!msg || !isSharing) return alert("Go Online first");
            const app = window.firebaseApp;
            const db = getFirestore(app);
            try {
                const ref = doc(db, 'announcements', activeBusNo);
                await setDoc(ref, { bus_no: activeBusNo, latest_message: msg, last_updated: serverTimestamp() }, { merge: true });
                await addDoc(collection(ref, 'messages'), { message: msg, timestamp: serverTimestamp(), bus_no: activeBusNo });
                inputAnnounce.value = ""; alert("Sent");
            } catch (e) { }
        });

        // SOCKET
        const socket = io();
        socket.on('connect', () => {
            document.getElementById('serverStatus').textContent = "ONLINE";
            document.getElementById('serverStatus').classList.replace('text-slate-300', 'text-green-400');
            document.getElementById('status-dot').classList.replace('bg-red-500', 'bg-green-500');
            document.getElementById('status-dot').classList.remove('animate-pulse');
        });

    </script>
</body>

</html>