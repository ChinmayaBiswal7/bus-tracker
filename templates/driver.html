<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver Console | Campus Ride</title>

    <!-- Core Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="/static/pwa-update.js"></script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: #0f172a;
            overflow: hidden;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        #map {
            height: 100vh;
            width: 100vw;
            z-index: 0;
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .pulse-ring {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            animation: pulse-blue 2s infinite;
        }

        @keyframes pulse-blue {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 15px rgba(59, 130, 246, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        /* Drawer Transition */
        .drawer-closed {
            transform: translateY(110%);
        }

        .drawer-open {
            transform: translateY(0);
        }

        /* Loading Spinner */
        .loader {
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body id="main-body" style="display: none;">

    <!-- Auth Guard -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const guardConfig = {
            apiKey: "AIzaSyAW7XS_Q_Kdh2eiYEaKBEHvZDpOk7-ynDg",
            authDomain: "bustracker-c0af6.firebaseapp.com",
            projectId: "bustracker-c0af6",
            storageBucket: "bustracker-c0af6.firebasestorage.app",
            messagingSenderId: "103145940746",
            appId: "1:103145940746:web:80a8444bff23e75b94fcf3",
            measurementId: "G-PKF72NB657"
        };

        const guardApp = initializeApp(guardConfig);
        window.firebaseApp = guardApp;
        const auth = getAuth(guardApp);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('main-body').style.display = 'block';
                if (window.initMap) window.initMap(); // Init map after auth
            } else {
                window.location.href = '/login?role=driver';
            }
        });

        window.logout = function () {
            auth.signOut().then(() => window.location.href = '/');
        }
    </script>

    <!-- MAP BACKGROUND -->
    <div id="map"></div>

    <!-- TOP BAR (Status) -->
    <div class="fixed top-0 left-0 right-0 p-4 z-20 flex justify-between items-start pointer-events-none">

        <!-- Connection Badge -->
        <div class="glass-panel px-3 py-1.5 rounded-full flex items-center gap-2 pointer-events-auto">
            <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
            <span id="serverStatus" class="text-[10px] font-bold text-slate-300 uppercase tracking-wider">OFFLINE</span>
        </div>

        <!-- Speed & Stats -->
        <div class="flex flex-col items-end gap-2">
            <div class="glass-panel px-4 py-2 rounded-2xl flex flex-col items-center pointer-events-auto min-w-[80px]">
                <span class="text-[10px] text-slate-400 uppercase font-bold">Speed</span>
                <span class="text-2xl font-bold text-white mono leading-none"><span id="speedVal">0</span></span>
                <span class="text-[10px] text-slate-500">km/h</span>
            </div>

            <div class="glass-panel px-3 py-1 rounded-full flex items-center gap-1.5 pointer-events-auto">
                <svg class="w-3 h-3 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 18d2 2 0 100-4 2 2 0 000 4z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16.24 7.76a6 6 0 10-8.49 0" />
                </svg>
                <span id="accVal" class="text-[10px] font-mono text-slate-300">--</span>
            </div>
        </div>
    </div>

    <!-- LOGOUT BUTTON (Top Left) -->
    <button onclick="logout()"
        class="fixed top-20 left-4 z-20 w-10 h-10 glass-panel rounded-full flex items-center justify-center text-slate-400 hover:text-white transition-colors shadow-lg active:scale-95">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
        </svg>
    </button>

    <!-- FAB: ANNOUNCEMENTS (Bottom Right) -->
    <button id="fab-announce" onclick="toggleDrawer()"
        class="fixed bottom-36 right-6 z-30 w-14 h-14 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-full shadow-lg shadow-blue-500/40 flex items-center justify-center text-white hover:scale-105 active:scale-95 transition-all">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
            </path>
        </svg>
        <!-- Unread Dot (optional) -->
        <span class="absolute top-3 right-3 w-3 h-3 bg-red-500 border-2 border-slate-900 rounded-full hidden"></span>
    </button>


    <!-- MAIN DRIVE CONTROLS (Bottom Floating Island) -->
    <div class="fixed bottom-6 left-4 right-4 z-30 flex flex-col items-center">

        <div
            class="glass-panel w-full max-w-md p-4 rounded-[2rem] shadow-2xl border border-white/10 bg-slate-900/90 relative overflow-hidden group">

            <!-- Type Toggle & Input Row -->
            <div class="flex items-center gap-3 mb-4 transition-all duration-300" id="config-row">
                <!-- Toggle -->
                <div class="bg-slate-800/50 p-1 rounded-xl flex border border-slate-700 w-32 shrink-0 relative">
                    <div id="active-blob"
                        class="absolute inset-y-1 left-1 w-[calc(50%-4px)] bg-blue-500 rounded-lg transition-all duration-300">
                    </div>
                    <button onclick="setMode('BUS')"
                        class="relative z-10 w-1/2 text-xs font-bold text-white py-2 text-center">BUS</button>
                    <button onclick="setMode('EV')"
                        class="relative z-10 w-1/2 text-xs font-bold text-slate-400 py-2 text-center">EV</button>
                </div>

                <!-- Input -->
                <input type="text" id="busInput" placeholder="BUS NO."
                    class="w-full bg-transparent border-b border-slate-600 text-center text-xl font-bold text-white py-1 focus:outline-none focus:border-blue-500 placeholder-slate-600 mono uppercase">
            </div>

            <!-- Main Button -->
            <button id="toggleBtn"
                class="w-full py-4 bg-blue-600 hover:bg-blue-500 active:scale-[0.98] rounded-2xl text-white font-bold text-lg shadow-lg shadow-blue-900/50 transition-all flex items-center justify-center gap-3">
                <span class="text-2xl">â–¶</span> START DRIVING
            </button>

            <!-- Locked Cover (When active) -->
            <div id="active-cover" class="hidden absolute inset-0 bg-slate-900/50 backdrop-blur-sm z-0"></div>
        </div>

        <p class="text-[10px] text-slate-500 mt-2 font-mono" id="debug-text">Ready to connect...</p>
    </div>


    <!-- ANNOUNCEMENT DRAWER (Slide Up) -->
    <div id="drawer-backdrop" onclick="toggleDrawer()"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-30 hidden transition-opacity opacity-0"></div>

    <div id="announcement-drawer"
        class="fixed bottom-0 inset-x-0 bg-slate-900 z-40 rounded-t-[2.5rem] shadow-[0_-10px_40px_rgba(0,0,0,0.5)] transform drawer-closed transition-transform duration-300 border-t border-slate-700/50 max-h-[80vh] flex flex-col">

        <!-- Handle -->
        <div class="w-full flex justify-center pt-3 pb-1" onclick="toggleDrawer()">
            <div class="w-12 h-1.5 bg-slate-700 rounded-full"></div>
        </div>

        <div class="p-6">
            <h2 class="text-xl font-bold text-white mb-1 flex items-center gap-2">
                ðŸ“¢ Announcements
                <span class="text-xs bg-slate-800 px-2 py-0.5 rounded text-slate-400 font-normal">Broadcast</span>
            </h2>
            <p class="text-xs text-slate-500 mb-6">Send urgent updates to students tracked to this bus.</p>

            <!-- Input Area -->
            <div class="relative">
                <textarea id="announceInput" rows="3" placeholder="Type message... (e.g. Traffic delay)"
                    class="w-full bg-slate-800 border border-slate-700 rounded-2xl p-4 text-sm text-white focus:outline-none focus:border-blue-500 resize-none mb-3"></textarea>

                <!-- AI Button (Inside) -->
                <button id="btnAiAssist"
                    class="absolute bottom-6 right-3 p-2 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl text-white shadow-lg hover:scale-110 transition-transform"
                    title="Standardize with AI">
                    <span class="text-lg">âœ¨</span>
                </button>
            </div>

            <!-- Actions -->
            <button id="btnAnnounce"
                class="w-full py-3.5 bg-slate-100 hover:bg-white text-slate-900 font-bold rounded-xl transition-colors flex items-center justify-center gap-2 shadow-lg">
                ðŸš€ SEND ALERT
            </button>
        </div>
    </div>


    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- MAP & UI STATE ---
        let map, userMarker;
        window.initMap = function () {
            if (map) return;
            // Default center, will behave if GPS kicks in
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([20.2961, 85.8245], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ''
            }).addTo(map);

            // Custom Marker
            const icon = L.divIcon({
                className: 'custom-icon',
                html: `<div class="w-6 h-6 bg-blue-500 rounded-full border-4 border-white shadow-lg pulse-ring"></div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            userMarker = L.marker([0, 0], { icon: icon });
        }

        // --- CORE VARIABLES ---
        const socket = io();
        const app = window.firebaseApp;
        const db = getFirestore(app);

        let watchId = null;
        let isSharing = false;
        let currentMode = 'BUS';
        let activeBusNo = null;

        // --- UI ELEMENTS ---
        const btnMain = document.getElementById('toggleBtn');
        const busInput = document.getElementById('busInput');

        // Mode Toggle
        window.setMode = function (mode) {
            if (isSharing) return;
            currentMode = mode;
            const blob = document.getElementById('active-blob');

            if (mode === 'BUS') {
                blob.style.transform = 'translateX(0)';
                blob.classList.replace('bg-emerald-500', 'bg-blue-500');
                busInput.placeholder = "BUS NO.";
                busInput.value = "";
                busInput.disabled = false;
            } else {
                blob.style.transform = 'translateX(100%)';
                blob.classList.replace('bg-blue-500', 'bg-emerald-500');
                busInput.value = "EV-" + Math.floor(Math.random() * 9000 + 1000);
                busInput.disabled = true;
            }
        }

        // --- MAIN DRIVE LOGIC ---
        btnMain.addEventListener('click', () => {
            if (!isSharing) {
                // START
                let busNo = busInput.value.trim().toUpperCase();
                if (!busNo) {
                    alert('Please enter Bus Number');
                    return;
                }
                startSession(busNo);
            } else {
                // STOP
                stopSession();
            }
        });

        function startSession(busNo) {
            if (!navigator.geolocation) return alert("No GPS support");

            activeBusNo = busNo;
            isSharing = true;

            // UI Update
            btnMain.innerHTML = `<span class="text-2xl">â– </span> STOP SHARING`;
            btnMain.classList.replace('bg-blue-600', 'bg-red-500');
            btnMain.classList.replace('hover:bg-blue-500', 'hover:bg-red-600');
            btnMain.classList.add('shadow-red-900/50');

            // Lock Inputs
            document.getElementById('config-row').classList.add('opacity-50', 'pointer-events-none');

            // Start Watch
            const options = { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 };
            watchId = navigator.geolocation.watchPosition(
                (pos) => { handleLocation(pos, busNo) },
                (err) => { console.error(err); document.getElementById('debug-text').textContent = "GPS Error: " + err.message; },
                options
            );
        }

        function stopSession() {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            watchId = null;
            isSharing = false;
            activeBusNo = null;

            socket.emit('driver_update', null); // Kill signal

            // UI Reset
            btnMain.innerHTML = `<span class="text-2xl">â–¶</span> START DRIVING`;
            btnMain.classList.replace('bg-red-500', 'bg-blue-600');
            btnMain.classList.replace('hover:bg-red-600', 'hover:bg-blue-500');
            btnMain.classList.remove('shadow-red-900/50');

            document.getElementById('config-row').classList.remove('opacity-50', 'pointer-events-none');
            document.getElementById('debug-text').textContent = "Session ended";
            document.getElementById('speedVal').textContent = "0";
            document.getElementById('accVal').textContent = "--";

            if (userMarker && map) map.removeLayer(userMarker);
        }

        function handleLocation(pos, busNo) {
            if (!isSharing) return;

            const { latitude, longitude, speed, accuracy, heading } = pos.coords;
            const speedKmh = speed ? (speed * 3.6).toFixed(0) : 0;

            // Update UI Stats
            document.getElementById('speedVal').textContent = speedKmh;
            document.getElementById('accVal').textContent = `Acc: ${Math.round(accuracy)}m`;
            document.getElementById('debug-text').textContent = `Broadcasting... ${new Date().toLocaleTimeString()}`;

            // Update Map
            if (map) {
                userMarker.setLatLng([latitude, longitude]).addTo(map);
                map.setView([latitude, longitude], 16); // Follow user
            }

            // Emit to Server
            socket.emit('driver_update', {
                lat: latitude,
                lng: longitude,
                accuracy, speed, heading,
                bus_no: busNo
            });
        }

        // --- DRAWER & AI LOGIC ---
        const drawer = document.getElementById('announcement-drawer');
        const backdrop = document.getElementById('drawer-backdrop');
        const fab = document.getElementById('fab-announce');

        window.toggleDrawer = function () {
            const isOpen = !drawer.classList.contains('drawer-closed');
            if (isOpen) {
                drawer.classList.add('drawer-closed');
                drawer.classList.remove('drawer-open');
                backdrop.classList.add('hidden');
                backdrop.classList.remove('opacity-100');
                fab.classList.remove('scale-0');
            } else {
                drawer.classList.remove('drawer-closed');
                drawer.classList.add('drawer-open');
                backdrop.classList.remove('hidden');
                setTimeout(() => backdrop.classList.add('opacity-100'), 10);
                fab.classList.add('scale-0'); // Hide FAB when open
            }
        }

        // AI ASSIST
        const btnAi = document.getElementById('btnAiAssist');
        const inputAnnounce = document.getElementById('announceInput');

        btnAi.addEventListener('click', async () => {
            const text = inputAnnounce.value;
            if (!text) return;

            const oldIcon = btnAi.innerHTML;
            btnAi.innerHTML = '<div class="loader w-5 h-5 border-white"></div>';
            btnAi.disabled = true;

            try {
                const res = await fetch('/api/driver/ai-assist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                const data = await res.json();
                if (data.response) inputAnnounce.value = data.response;
            } catch (e) {
                alert('AI Error');
            } finally {
                btnAi.innerHTML = oldIcon;
                btnAi.disabled = false;
            }
        });

        // SEND ANNOUNCEMENT
        document.getElementById('btnAnnounce').addEventListener('click', async () => {
            const msg = inputAnnounce.value;
            if (!msg) return;
            if (!activeBusNo) return alert('Start driving first to identify your bus!');

            try {
                const busRef = doc(db, 'announcements', activeBusNo);
                await setDoc(busRef, {
                    bus_no: activeBusNo,
                    latest_message: msg,
                    last_updated: serverTimestamp()
                }, { merge: true });

                await addDoc(collection(busRef, 'messages'), {
                    message: msg,
                    timestamp: serverTimestamp(),
                    bus_no: activeBusNo
                });

                inputAnnounce.value = "";
                toggleDrawer(); // Close on success
                alert('Alert Sent! ðŸš€');
            } catch (e) {
                console.error(e);
                alert('Failed to send');
            }
        });


        // --- SOCKET STATUS ---
        socket.on('connect', () => {
            document.getElementById('serverStatus').textContent = "LIVE";
            document.getElementById('serverStatus').className = "text-[10px] font-bold text-emerald-400 uppercase tracking-wider";
            document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]";
        });
        socket.on('disconnect', () => {
            document.getElementById('serverStatus').textContent = "OFFLINE";
            document.getElementById('serverStatus').className = "text-[10px] font-bold text-red-400 uppercase tracking-wider";
            document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
        });

    </script>
</body>

</html>