<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver Console | Campus Ride</title>

    <!-- Core Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="/static/pwa-update.js"></script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: #0f172a;
            overflow: hidden;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 35vh;
            /* Leave space for panel */
            z-index: 0;
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        /* Dashboard Panel */
        .dashboard-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 38vh;
            background: #0f172a;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
            z-index: 10;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
        }

        /* Cards */
        .dash-card {
            background: rgba(30, 41, 59, 0.5);
            /* Slate-800/50 */
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(10px);
        }

        /* Speedometer CSS */
        .gauge-container {
            position: relative;
            width: 120px;
            height: 60px;
            /* Half circle */
            overflow: hidden;
            margin: 0 auto;
        }

        .gauge-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 10px solid rgba(255, 255, 255, 0.1);
            border-bottom-color: transparent;
            border-left-color: transparent;
            /* Hide bottom half roughly */
            transform: rotate(135deg);
            /* Init rotation */
        }

        .gauge-fill {
            position: absolute;
            top: 0;
            left: 0;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 10px solid transparent;
            border-top-color: #3b82f6;
            /* Blue fill */
            border-right-color: #3b82f6;
            transform: rotate(45deg);
            /* Start at 45 (empty) */
            transition: transform 0.5s ease-out;
            transform-origin: center;
        }

        .pulse-ring {
            animation: pulse-blue 2s infinite;
        }

        @keyframes pulse-blue {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 15px rgba(59, 130, 246, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        /* Loader */
        .loader {
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body id="main-body" style="display: none;">

    <!-- Auth Guard (Same) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        const guardConfig = { apiKey: "AIzaSyAW7XS_Q_Kdh2eiYEaKBEHvZDpOk7-ynDg", authDomain: "bustracker-c0af6.firebaseapp.com", projectId: "bustracker-c0af6", storageBucket: "bustracker-c0af6.firebasestorage.app", messagingSenderId: "103145940746", appId: "1:103145940746:web:80a8444bff23e75b94fcf3", measurementId: "G-PKF72NB657" };
        const guardApp = initializeApp(guardConfig); window.firebaseApp = guardApp; const auth = getAuth(guardApp);
        onAuthStateChanged(auth, (user) => { if (user) { document.getElementById('main-body').style.display = 'block'; if (window.initMap) window.initMap(); } else { window.location.href = '/login?role=driver'; } });
        window.logout = function () { auth.signOut().then(() => window.location.href = '/'); }
    </script>

    <!-- MAP AREA -->
    <div id="map"></div>

    <!-- DASHBOARD PANEL -->
    <div class="dashboard-panel">

        <!-- Header -->
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <img src="https://cdn-icons-png.flaticon.com/512/2641/2641333.png"
                    class="w-10 h-10 rounded-full bg-slate-700 p-1" alt="Driver">
                <div>
                    <h1 class="text-white font-bold text-lg leading-tight">Driver Console</h1>
                    <p class="text-[10px] text-slate-400">Manage Route & Comms</p>
                </div>
            </div>

            <button onclick="logout()"
                class="bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-500 hover:to-rose-500 text-white px-4 py-2 rounded-lg text-xs font-bold shadow-lg flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                    </path>
                </svg>
                End Shift
            </button>
        </div>

        <!-- 3-Column Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 h-full">

            <!-- CARD 1: CURRENT ROUTE (Controls) -->
            <div class="dash-card justify-between relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity">
                    <svg class="w-24 h-24 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </div>

                <div>
                    <div class="flex items-center gap-2 mb-3">
                        <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                        </svg>
                        <h2 class="text-slate-200 font-bold text-sm uppercase tracking-wide">Route Config</h2>
                    </div>

                    <!-- Toggle & Input -->
                    <div class="flex flex-col gap-3">
                        <div class="flex bg-slate-900/50 p-1 rounded-lg border border-slate-700 relative isolate"
                            id="mode-toggle">
                            <div id="active-blob"
                                class="absolute inset-y-1 left-1 w-[calc(50%-4px)] bg-blue-600 rounded-md transition-all duration-300 -z-10">
                            </div>
                            <button onclick="setMode('BUS')"
                                class="flex-1 py-1.5 text-xs font-bold text-white transition-colors z-10">BUS</button>
                            <button onclick="setMode('EV')"
                                class="flex-1 py-1.5 text-xs font-bold text-slate-400 transition-colors z-10">EV</button>
                        </div>
                        <input type="text" id="busInput" placeholder="ENTER BUS NO."
                            class="bg-slate-900/50 border border-slate-700 text-white text-center font-bold text-lg rounded-lg py-2 focus:border-blue-500 focus:outline-none placeholder-slate-600 mono uppercase w-full">
                    </div>
                </div>

                <div class="mt-2">
                    <button id="toggleBtn"
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold text-sm shadow-lg shadow-blue-900/30 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <span class="text-lg">â–¶</span> START SHARING
                    </button>
                    <p class="text-[10px] text-slate-500 text-center mt-2 mono" id="last-updated">Status: Idle</p>
                </div>
            </div>


            <!-- CARD 2: ANNOUNCEMENTS (Center) -->
            <div class="dash-card relative">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z">
                            </path>
                        </svg>
                        <h2 class="text-slate-200 font-bold text-sm uppercase tracking-wide">Announcements</h2>
                    </div>
                    <span class="text-[10px] bg-slate-700/50 px-2 py-0.5 rounded text-slate-300">Broadcast</span>
                </div>

                <div class="flex-1 relative mb-2">
                    <textarea id="announceInput"
                        class="w-full h-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 text-xs text-white focus:border-purple-500 focus:outline-none resize-none"
                        placeholder="Type urgent message here (e.g. Route diverted)..."></textarea>

                    <button id="btnAiAssist"
                        class="absolute bottom-2 right-2 p-1.5 bg-slate-700/80 hover:bg-purple-600 rounded-lg text-white transition-colors"
                        title="AI Polish">
                        <span class="text-lg">âœ¨</span>
                    </button>
                </div>

                <button id="btnAnnounce"
                    class="w-full bg-gradient-to-r from-slate-700 to-slate-800 hover:from-white hover:to-white hover:text-slate-900 text-slate-300 py-2.5 rounded-lg font-bold text-xs border border-slate-600 transition-all flex items-center justify-center gap-2">
                    ðŸš€ SEND ALERT
                </button>
            </div>


            <!-- CARD 3: TELEMETRY (Speed) -->
            <div class="dash-card items-center justify-center">
                <div class="flex items-center justify-between w-full mb-4 px-2">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0">
                            </path>
                        </svg>
                        <span class="text-xs font-bold text-slate-400">Signal</span>
                    </div>
                    <span id="gps-quality" class="text-xs font-mono text-slate-500">--</span>
                </div>

                <!-- CSS Gauge -->
                <div class="relative mb-2">
                    <svg class="w-32 h-16 overflow-hidden" viewBox="0 0 100 50">
                        <!-- BG Arc -->
                        <path d="M10,50 A40,40 0 1,1 90,50" fill="none" stroke="#1e293b" stroke-width="8"
                            stroke-linecap="round" />
                        <!-- Fill Arc (Dynamic) -->
                        <path id="speed-arc" d="M10,50 A40,40 0 1,1 90,50" fill="none" stroke="#3b82f6" stroke-width="8"
                            stroke-linecap="round" stroke-dasharray="126" stroke-dashoffset="126"
                            class="transition-all duration-500 ease-out" />
                    </svg>
                    <div class="absolute bottom-0 left-1/2 -translate-x-1/2 text-center">
                        <div class="text-3xl font-bold text-white mono leading-none" id="speedVal">0</div>
                        <div class="text-[10px] text-slate-500 font-bold uppercase">km/h</div>
                    </div>
                </div>

                <div class="w-full bg-slate-900/50 rounded-lg py-1 px-3 flex justify-between items-center mt-auto">
                    <span class="text-[10px] text-slate-500">Server</span>
                    <div class="flex items-center gap-1.5">
                        <div id="status-dot" class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></div>
                        <span id="serverStatus" class="text-[10px] font-bold text-slate-400">OFFLINE</span>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <!-- SCRIPT -->
    <script type="module">
        import { getFirestore, doc, setDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // APP STATE
        let map, userMarker, watchId;
        let isSharing = false;
        let currentMode = 'BUS';
        let activeBusNo = null;

        // UI REFS
        const btnMain = document.getElementById('toggleBtn');
        const busInput = document.getElementById('busInput');
        const speedVal = document.getElementById('speedVal');
        const speedArc = document.getElementById('speed-arc');
        const gpsLabel = document.getElementById('gps-quality');
        const lastUpdated = document.getElementById('last-updated');

        // --- 1. MODE & CONFIG ---
        window.setMode = function (mode) {
            if (isSharing) return;
            currentMode = mode;
            const blob = document.getElementById('active-blob');
            const btns = document.getElementById('mode-toggle').querySelectorAll('button');

            if (mode === 'BUS') {
                blob.style.transform = 'translateX(0)';
                blob.classList.replace('bg-emerald-600', 'bg-blue-600');
                btns[0].classList.replace('text-slate-400', 'text-white');
                btns[1].classList.replace('text-white', 'text-slate-400');
                busInput.value = "";
                busInput.disabled = false;
            } else {
                blob.style.transform = 'translateX(100%)';
                blob.classList.replace('bg-blue-600', 'bg-emerald-600');
                btns[1].classList.replace('text-slate-400', 'text-white');
                btns[0].classList.replace('text-white', 'text-slate-400');
                busInput.value = "EV-" + Math.floor(Math.random() * 9000 + 1000);
                busInput.disabled = true;
            }
        }

        // --- 2. DRIVE LOGIC ---
        btnMain.addEventListener('click', () => {
            if (!isSharing) {
                const busNo = busInput.value.trim().toUpperCase();
                if (!busNo) return alert("Enter Bus Number");
                startSession(busNo);
            } else {
                stopSession();
            }
        });

        function startSession(busNo) {
            if (!navigator.geolocation) return alert("GPS Error");
            activeBusNo = busNo;
            isSharing = true;

            // UI LOCK
            busInput.disabled = true;
            document.getElementById('mode-toggle').classList.add('opacity-50', 'pointer-events-none');

            btnMain.innerHTML = `<span class="text-lg">â– </span> STOP SHARING`;
            btnMain.className = "w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold text-sm shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2";

            const opts = { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 };
            watchId = navigator.geolocation.watchPosition(
                (pos) => handleGPS(pos, busNo),
                (err) => { lastUpdated.textContent = "GPS Err: " + err.message; },
                opts
            );
        }

        function stopSession() {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            watchId = null;
            isSharing = false;

            socket.emit('driver_update', null);

            // UI UNLOCK
            busInput.disabled = (currentMode === 'EV');
            document.getElementById('mode-toggle').classList.remove('opacity-50', 'pointer-events-none');

            btnMain.innerHTML = `<span class="text-lg">â–¶</span> START SHARING`;
            btnMain.className = "w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold text-sm shadow-lg shadow-blue-900/30 active:scale-95 transition-all flex items-center justify-center gap-2";

            // Reset Stats
            updateSpeed(0);
            gpsLabel.textContent = "--";
            lastUpdated.textContent = "Status: Idle";
        }

        function handleGPS(pos, busNo) {
            const { latitude, longitude, speed, accuracy, heading } = pos.coords;

            // Update Speed Gauge
            const kmh = speed ? speed * 3.6 : 0;
            updateSpeed(kmh);

            // Update Labels
            gpsLabel.textContent = `Â±${Math.round(accuracy)}m`;
            gpsLabel.className = accuracy < 20 ? "text-xs font-mono text-green-400" : "text-xs font-mono text-yellow-500";
            lastUpdated.textContent = "Live: " + new Date().toLocaleTimeString();

            // Map
            if (map) {
                userMarker.setLatLng([latitude, longitude]).addTo(map);
                map.setView([latitude, longitude], 16);
            }

            // Server
            socket.emit('driver_update', { lat: latitude, lng: longitude, speed, heading, bus_no: busNo, accuracy });
        }

        function updateSpeed(kmh) {
            speedVal.textContent = Math.round(kmh);
            // 126 is full arc (pi * r roughly for this path). Scale 0-100kmh
            const maxVal = 126;
            const percent = Math.min(kmh / 100, 1);
            const offset = maxVal - (percent * maxVal);
            speedArc.style.strokeDashoffset = offset;
            speedArc.style.stroke = kmh > 60 ? '#ef4444' : (kmh > 40 ? '#eab308' : '#3b82f6');
        }

        // --- 3. ANNOUNCEMENTS ---
        const btnAi = document.getElementById('btnAiAssist');
        const inputAnnounce = document.getElementById('announceInput');
        const btnSend = document.getElementById('btnAnnounce');

        btnAi.addEventListener('click', async () => {
            const text = inputAnnounce.value;
            if (!text) return;
            const oldIcon = btnAi.innerHTML;
            btnAi.innerHTML = '<div class="loader w-3 h-3 border-white"></div>';
            try {
                const res = await fetch('/api/driver/ai-assist', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
                const data = await res.json();
                if (data.response) inputAnnounce.value = data.response;
            } catch (e) { alert('AI Error'); }
            finally { btnAi.innerHTML = oldIcon; }
        });

        btnSend.addEventListener('click', async () => {
            const msg = inputAnnounce.value;
            if (!msg) return;
            if (!isSharing) return alert("Please Start Sharing First");

            const app = window.firebaseApp;
            const db = getFirestore(app);

            try {
                const ref = doc(db, 'announcements', activeBusNo);
                await setDoc(ref, { bus_no: activeBusNo, latest_message: msg, last_updated: serverTimestamp() }, { merge: true });
                await addDoc(collection(ref, 'messages'), { message: msg, timestamp: serverTimestamp(), bus_no: activeBusNo });
                inputAnnounce.value = "";
                alert("Sent! ðŸ“¢");
            } catch (e) { console.error(e); alert("Send Failed"); }
        });

        // --- 4. MAP & SOCKET ---
        const socket = io();
        socket.on('connect', () => {
            document.getElementById('serverStatus').textContent = "ONLINE";
            document.getElementById('serverStatus').classList.replace('text-slate-400', 'text-green-400');
            document.getElementById('status-dot').classList.replace('bg-red-500', 'bg-green-500');
            document.getElementById('status-dot').classList.remove('animate-pulse');
        });

        window.initMap = function () {
            if (map) return;
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([20.2961, 85.8245], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);
            const icon = L.divIcon({ className: 'custom-icon', html: `<div class="w-6 h-6 bg-blue-500 rounded-full border-4 border-white shadow-lg pulse-ring"></div>`, iconSize: [24, 24], iconAnchor: [12, 12] });
            userMarker = L.marker([0, 0], { icon: icon });
        }

    </script>
</body>

</html>